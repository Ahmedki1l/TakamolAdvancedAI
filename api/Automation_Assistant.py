import json
from openai import OpenAI
from dotenv import load_dotenv
import os

# Load environment variables from .env file
load_dotenv()

# Access the API key
api_key = os.getenv('OPENAI_API_KEY')

client = OpenAI(api_key=api_key)

# وظيفة لتحليل المشروع العقاري وتوليد الاستراتيجيات الإعلانية
def generate_real_estate_campaign(user_input):
    user_prompt = f"""
    {user_input}

    قم بتحليل هذا المشروع وتحديد الجمهور المستهدف لجميع المنصات. يجب أن تشمل المخرجات تقسيم الجمهور حسب الفئة العمرية، الدخل، الموقع الجغرافي، والاهتمامات. أيضًا، يجب أن تشمل الاستراتيجيات الإعلانية الموصى بها لكل منصة مع نوع الإعلانات الأنسب.
    
    استناداً إلى البيانات الحالية للسوق لكل منصة إعلانية (فيسبوك، إنستغرام، لينكد إن، جوجل، تويتر)، قم بإعداد دراسة كاملة تشمل ما يلي:
    1. استراتيجية السوق لكل منصة بناءً على البيانات الحالية(Market_Strategy):
        - فيسبوك: استراتيجية السوق، مؤشرات الأداء، التكلفة السنوية، الرؤى، التوصيات، التكرار الأسبوعي، النقرات اليومية (daily_clicks)، نسبة النقر (CTR)، نسبة التحويل (conversion_rate)، تكلفة التسويق (marketing_cost).
        - إنستغرام: استراتيجية السوق، مؤشرات الأداء، التكلفة السنوية، الرؤى، التوصيات، التكرار الأسبوعي، النقرات اليومية (daily_clicks)، نسبة النقر (CTR)، نسبة التحويل (conversion_rate)، تكلفة التسويق (marketing_cost).
        - لينكد إن: استراتيجية السوق، مؤشرات الأداء، التكلفة السنوية، الرؤى، التوصيات، التكرار الأسبوعي، النقرات اليومية (daily_clicks)، نسبة النقر (CTR)، نسبة التحويل (conversion_rate)، تكلفة التسويق (marketing_cost).
        - جوجل: استراتيجية السوق، مؤشرات الأداء، التكلفة السنوية، الرؤى، التوصيات، التكرار الأسبوعي، النقرات اليومية (daily_clicks)، نسبة النقر (CTR)، نسبة التحويل (conversion_rate)، تكلفة التسويق (marketing_cost).
        - تويتر: استراتيجية السوق، مؤشرات الأداء، التكلفة السنوية، الرؤى، التوصيات، التكرار الأسبوعي، النقرات اليومية (daily_clicks)، نسبة النقر (CTR)، نسبة التحويل (conversion_rate)، تكلفة التسويق (marketing_cost).
        
    2. مؤشرات الأداء الرئيسية (KPIs) المتوقعة بناءً على الاتجاهات الحالية لكل منصة(Performance_Metrics).
    3. التكلفة التسويقية السنوية المتوقعة بناءً على بيانات السوق الحالية(ROI_Calculation).
         - قانون حساب نسبة العائد على الاستثمار (ROI): 
        \[
        \text{{ROI}} = \left( \frac{{\text{{صافي الربح}}}}{{\text{{تكلفة التسويق}}}} \right) \times 100
        \]
        - تأكد من حساب ROI وفقًا لهذا القانون مع إضافة علامة "%" في النهاية.
    4. رؤى استراتيجية بناءً على السوق الحالي، تشمل الفرص والمخاطر(Strategic_Insights).
    5. التوصيات لتحسين الأداء الإعلاني بناءً على ظروف السوق الحالية(Recommendations).
    6. التكرار الأسبوعي الموصى به للمنشورات على كل منصة بناءً على الاتجاهات الحالية(Post_Frequency).

    تأكد من تقديم النتائج في صيغة JSON مع الحفاظ على هذا الترتيب:
    1. فيسبوك: الفئة_العمرية، الدخل، الموقع_الجغرافي، الاهتمامات، السلوك، نوع_الإعلانات، الأهداف.
    2. إنستغرام: الفئة_العمرية، الدخل، الاهتمامات، السلوك، نوع_الإعلانات، الأهداف.
    3. لينكد_إن: الفئة_المستهدفة، الدخل، الاهتمامات، نوع_الإعلانات، الأهداف.
    4. تويتر: الفئة العمرية، الدخل، الاهتمامات، السلوك، نوع الإعلانات، الأهداف.
    5. جوجل: الكلمات_المفتاحية، نوع_الإعلانات، الأهداف.
    6.Market_Strategy.
    7.Performance_Metrics.
    8.ROI_Calculations.
    9.Strategic_Insights.
    10.Recommendations.
    11.Post_Frequency.
    
    json format:
    {"""
        {
           "Target_Audience": {
              "فيسبوك": {
                 "الفئة_العمرية": "",
                 "الدخل": "",
                 "الموقع_الجغرافي": "",
                 "الاهتمامات": [],
                 "السلوك": [],
                 "نوع_الإعلانات": [],
                 "الأهداف": []
              },
              "إنستغرام": {
                 "الفئة_العمرية": "",
                 "الدخل": "",
                 "الاهتمامات": [],
                 "السلوك": [],
                 "نوع_الإعلانات": [],
                 "الأهداف": []
              },
              "لينكد_إن": {
                 "الفئة_المستهدفة": "",
                 "الدخل": "",
                 "الاهتمامات": [],
                 "نوع_الإعلانات": [],
                 "الأهداف": []
              },
              "تويتر": {
                 "الفئة العمرية": "",
                 "الدخل": "",
                 "الاهتمامات": [],
                 "السلوك": [],
                 "نوع الإعلانات": [],
                 "الأهداف": []
              },
              "جوجل": {
                 "الكلمات_المفتاحية": [],
                 "نوع_الإعلانات": [],
                 "الأهداف": []
              }
           },
           "Market_Strategy": {
                "فيسبوك": {
                    "استراتيجية السوق": "",
                    "التوصيات": "",
                    "النقرات اليومية": "100",
                    "نسبة النقر (CTR)": "0.02",
                    "نسبة التحويل (conversion_rate)": "0.01",
                    "تكلفة التسويق الشهرية": "(يجب عليك دراسة المنصة وكتابة التكلفة هنا مع مراعاة عملة البلد)",
                    "التكلفة السنوية": ""
                },
                "إنستغرام": {
                    "استراتيجية السوق": "",
                    "التوصيات": "",
                    "النقرات اليومية": "80",
                    "نسبة النقر (CTR)": "0.03",
                    "نسبة التحويل (conversion_rate)": "0.015",
                    "تكلفة التسويق الشهرية": "(يجب عليك دراسة المنصة وكتابة التكلفة هنا مع مراعاة عملة البلد)",
                    "التكلفة السنوية": "",
                },
                "لينكد_إن": {
                    "استراتيجية السوق": "",
                    "التوصيات": "",
                    "النقرات اليومية": "50",
                    "نسبة النقر (CTR)": "0.015",
                    "نسبة التحويل (conversion_rate)": "0.02",
                    "تكلفة التسويق الشهرية": "(يجب عليك دراسة المنصة وكتابة التكلفة هنا مع مراعاة عملة البلد)",
                    "التكلفة السنوية": "",
                },
                "تويتر": {
                    "استراتيجية السوق": "",
                    "التوصيات": "",
                    "النقرات اليومية": "70",
                    "نسبة النقر (CTR)": "0.025",
                    "نسبة التحويل (conversion_rate)": "0.01",
                    "تكلفة التسويق الشهرية": "(يجب عليك دراسة المنصة وكتابة التكلفة هنا مع مراعاة عملة البلد)",
                    "التكلفة السنوية": "",
                },
                "جوجل": {
                    "استراتيجية السوق": "",
                    "التوصيات": "",
                    "النقرات اليومية": "90",
                    "نسبة النقر (CTR)": "0.04",
                    "نسبة التحويل (conversion_rate)": "0.02",
                    "تكلفة التسويق الشهرية": "(يجب عليك دراسة المنصة وكتابة التكلفة هنا مع مراعاة عملة البلد)",
                    "التكلفة السنوية": "",
              }
           },
           "Performance_Metrics": {
              "فيسبوك": ["نسبة التفاعل", "نسبة النقر"],
              "إنستغرام": ["عدد المتابعين", "نسبة التفاعل"],
              "لينكد_إن": ["عدد المشاهدات", "عدد المحادثات"],
              "تويتر": ["عدد الإشارات", "نسبة التفاعل"],
              "جوجل": ["عدد الزيارات", "عدد التفاعل"]
           },
           "ROI_Calculation": {
                "فيسبوك": {
                    "إسقاط_عدد_الزوار_السنوي": "",
                    "إسقاط_عدد_المبيعات_السنوي": "",
                    "إسقاط_الإيرادات_السنوية": "",
                    "تكلفة_التسويق_السنوية": "",
                    "صافي_الربح": "",
                    "نسبة_العائد_على_الاستثمار": ""
                },
                "إنستغرام": {
                    "إسقاط_عدد_الزوار_السنوي": "",
                    "إسقاط_عدد_المبيعات_السنوي": "",
                    "إسقاط_الإيرادات_السنوية": "",
                    "تكلفة_التسويق_السنوية": "",
                    "صافي_الربح": "",
                    "نسبة_العائد_على_الاستثمار": ""
                },
                "لينكد_إن": {
                    "إسقاط_عدد_الزوار_السنوي": "",
                    "إسقاط_عدد_المبيعات_السنوي": "",
                    "إسقاط_الإيرادات_السنوية": "",
                    "تكلفة_التسويق_السنوية": "",
                    "صافي_الربح": "",
                    "نسبة_العائد_على_الاستثمار": ""
                },
                "تويتر": {
                    "إسقاط_عدد_الزوار_السنوي": "",
                    "إسقاط_عدد_المبيعات_السنوي": "",
                    "إسقاط_الإيرادات_السنوية": "",
                    "تكلفة_التسويق_السنوية": "",
                    "صافي_الربح": "",
                    "نسبة_العائد_على_الاستثمار": ""
                },
                "جوجل": {
                    "إسقاط_عدد_الزوار_السنوي": "",
                    "إسقاط_عدد_المبيعات_السنوي": "",
                    "إسقاط_الإيرادات_السنوية": "",
                    "تكلفة_التسويق_السنوية": "",
                    "صافي_الربح": "",
                    "نسبة_العائد_على_الاستثمار": ""
                }
            },
           "Strategic_Insights": {
              "الفرص": "",
              "المخاطر": ""
           },
           "Recommendations": {
              "تحسين الإعلانات": "",
              "زيادة التفاعل": "",
              "استهداف دقيق": ""
           },
           "Post_Frequency": {
              "فيسبوك": "",
              "إنستغرام": "",
              "لينكد_إن": "",
              "تويتر": "",
              "جوجل": ""
           }
        }

    """}
    إرشادات: 
    أعطني فقط البيانات بدون اسم المشروع او أي شئ آخر .. فقط اتبع الترتيب بالأعلى و اعجلها لجميع المنصات 
    
    """

    system_prompt = f""" أنت أفضل media buyer متخصص. يجب عليك أن تلبي إحتياجات العميل على أكمل وجه ممكن."""

    context = [{"role": "system", "content": system_prompt},{"role": "user", "content": user_prompt}]
    parsed_ai_response = ''
    try:
        chat_completion = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=context,
            max_tokens=16384,
            response_format={"type": "json_object"},
        )

        # Fetching the response assuming it is structured as instructed
        response = chat_completion.choices[0].message.content
        print("Raw AI response:", response)

        # Attempt to parse the response to ensure it is valid JSON
        parsed_ai_response = json.loads(response)
        print("Parsed AI response:", parsed_ai_response)
    except json.JSONDecodeError as e:
        print(f"Failed to decode JSON: {str(e)}")
    except Exception as e:
        print(f"An error occurred: {str(e)}")

    return parsed_ai_response

# وظيفة لتنظيم المخرجات في صيغة JSON
def organize_campaign_output(project_name, location, platforms, assets, insights):
    output = {
        "project_name": project_name,
        "location": location,
        "platforms": platforms,
        "assets": assets,
        "insights": json.loads(insights)
    }
    return json.dumps(output, ensure_ascii=False, indent=4)

# البيانات الخاصة بالمشروع
# project_name = "شقق النخبة الفاخرة"
# location = "الرياض، المملكة العربية السعودية"
# platforms = ["فيسبوك", "إنستغرام", "لينكد إن", "جوجل"]
# assets = {
#     "عدد غرف النوم": 4,
#     "عدد غرف المعيشة": 2,
#     "المساحة": "250 متر مربع",
#     "المزايا الفاخرة": ["مسبح خاص", "نادي رياضي مجهز", "مواد بناء عالية الجودة", "أمن وحراسة 24/7", "قريبة من المدارس الدولية والمراكز التجارية", "إطلالة بانورامية على المدينة"]
# }
#
# # الحصول على المخرجات من OpenAI
# insights = generate_real_estate_campaign(project_name, location, platforms, assets)
#
# # تنظيم المخرجات في صيغة JSON
# campaign_output = organize_campaign_output(project_name, location, platforms, assets, insights)
#
# print(campaign_output)
